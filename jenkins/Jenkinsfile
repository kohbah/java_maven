pipeline {
    agent any
    tools {
        maven 'maven'
        jdk 'java'
    }

    stages {

        stage('build && SonarQube analysis') {
            steps {
                withSonarQubeEnv('sonar') {
                        sh 'mvn clean package sonar:sonar'
                }
            }
        }

        stage ('Artifactory configuration') {
            steps {
                rtServer (
                    id: "jfrog",
                    url: 'http://10.0.1.113:8081/artifactory',
                    username: 'admin',
                    password: 'password'
                )

                rtMavenDeployer (
                    id: "maven_deployer",
                    serverId: "jfrog",
                    releaseRepo: "libs-release-local",
                    snapshotRepo: "libs-snapshot-local"
                )

                rtMavenResolver (
                    id: "maven_resolver",
                    serverId: "jfrog",
                    releaseRepo: "libs-release",
                    snapshotRepo: "libs-snapshot"
                )
            }
        }

        stage ('Exec Maven') {
            steps {
                rtMavenRun (
                    pom: 'pom.xml',
                    goals: 'clean install',
                    deployerId: "maven_deployer",
                    resolverId: "maven_resolver",
                    buildName: 'maven_app',
                    buildNumber: '0.0.1'
              )
            }
        }
        stage ("publish to artifactory") {
            steps {
                timeout(time: 2, unit: "MINUTES") {
                    input message: 'do you want to publish this build to artifactory server?', ok: 'Yes'
             }
            }
        }
        stage ('Publish build info') {
            steps {
                rtPublishBuildInfo (
                    serverId: "jfrog",
                    buildName: 'maven_app',
                    buildNumber: '0.0.1'
                )
            }
        }
        stage ('Deploy') {
            steps{
                sshagent (credentials : ['application']) {
                    sh 'ssh -o StrictHostKeyChecking=no jenkins@10.0.1.164 uptime'
                    sh 'ssh -v jenkins@10.0.1.164'
                    sh 'ssh jenkins@10.0.1.164  sudo mkdir -p /app01/hello'
                    sh 'scp -r /var/jenkins_home/workspace/kohbah.com/application/jenkins/scripts/deliver.sh sudo jenkins@10.0.1.164:/app01/hello'
                    sh 'scp -r target/${NAME}-${VERSION}.jar jenkins@10.0.1.164:/app01/hello'
                    sh 'ssh -o StrictHostKeyChecking=no jenkins@10.0.1.164 "sudo ./app01/hello/deliver.sh"'
                }
            }
        }
    }
    post {
        always {
             echo 'deleting the current directory'
             deleteDir()
             echo 'deleting @tmp directory'
             dir("${workspace}@tmp") {
                 deleteDir()
                 }
            }
    }
}